@page "/integration"

<div class="h-full overflow-auto bg-gray-50">
    <div class="max-w-4xl mx-auto p-8">
        @* Header *@
        <div class="mb-2 flex items-center gap-2 text-sm font-medium text-whatsapp">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"/></svg>
            Guia de Integracao
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-3">Integracao WhatsApp via Z-API + ERP CodeCycle</h1>
        <p class="text-lg text-gray-600 mb-10">
            Guia completo para os desenvolvedores da CodeCycle integrarem WhatsApp real
            no ERP Obraxs usando a plataforma Z-API como gateway.
        </p>

        @* ===== PARTE 1 — Z-API ===== *@
        <div class="rounded-lg bg-[#25d366]/10 p-4 mb-6">
            <h2 class="text-lg font-bold text-whatsapp">Parte 1 — Z-API na Pratica</h2>
            <p class="text-sm text-gray-600">O que e a Z-API, como funciona, vantagens sobre a Cloud API oficial.</p>
        </div>

        @* O que e Z-API *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">O que e a Z-API?</h2>
        <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm mb-8">
            <p class="text-sm text-gray-600 mb-4">
                A <strong>Z-API</strong> e uma plataforma brasileira que fornece uma API REST para integrar sistemas
                com o WhatsApp de forma simples. Usa o mesmo canal do WhatsApp Web, sem precisar de aprovacao da Meta
                ou verificacao de negocio.
            </p>
            <div class="grid md:grid-cols-3 gap-3">
                <div class="rounded-lg bg-gray-50 p-3">
                    <div class="text-sm font-medium text-gray-900">API REST Simples</div>
                    <div class="text-xs text-gray-500">Endpoints intuitivos: send-text, send-image, send-document. Zero burocracia Meta.</div>
                </div>
                <div class="rounded-lg bg-gray-50 p-3">
                    <div class="text-sm font-medium text-gray-900">Sem Limites de Mensagem</div>
                    <div class="text-xs text-gray-500">Nao ha tier de envio. Limite e o do WhatsApp Web normal.</div>
                </div>
                <div class="rounded-lg bg-gray-50 p-3">
                    <div class="text-sm font-medium text-gray-900">Multi-Device</div>
                    <div class="text-xs text-gray-500">Funciona com multi-device do WhatsApp. Celular nao precisa ficar online.</div>
                </div>
            </div>
        </div>

        @* Z-API vs Cloud API *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">Z-API vs Cloud API (Meta)</h2>
        <div class="rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden mb-8">
            <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-200 bg-gray-50"><th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Aspecto</th><th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Z-API</th><th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Cloud API (Meta)</th></tr></thead>
                <tbody>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Setup</td><td class="px-4 py-2 text-green-600">5 minutos (criar conta + QR code)</td><td class="px-4 py-2 text-gray-500">Dias (verificacao de negocio)</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Aprovacao</td><td class="px-4 py-2 text-green-600">Nenhuma</td><td class="px-4 py-2 text-gray-500">Meta Business Verification</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Templates</td><td class="px-4 py-2 text-green-600">Texto livre (sem template)</td><td class="px-4 py-2 text-gray-500">Templates pre-aprovados obrigatorios</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Custo por msg</td><td class="px-4 py-2 text-green-600">Incluso no plano mensal</td><td class="px-4 py-2 text-gray-500">~R$ 0,15-0,50 por mensagem</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Janela 24h</td><td class="px-4 py-2 text-green-600">Nao se aplica</td><td class="px-4 py-2 text-gray-500">Sim (template fora da janela)</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Webhook</td><td class="px-4 py-2">receive + status + disconnect</td><td class="px-4 py-2">messages + message_status</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Autenticacao</td><td class="px-4 py-2">Instance ID + Token + Client-Token</td><td class="px-4 py-2">OAuth 2.0 + System User Token</td></tr>
                    <tr><td class="px-4 py-2 font-medium">Ideal para</td><td class="px-4 py-2">PMEs, MVPs, demos, automacoes</td><td class="px-4 py-2">Grandes volumes, compliance</td></tr>
                </tbody>
            </table>
        </div>

        @* Como funciona *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">Como Funciona</h2>
        <div class="space-y-3 mb-8">
            @foreach (var step in _steps)
            {
                <div class="flex gap-4 rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
                    <div class="flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-whatsapp text-sm font-bold text-white">
                        @step.Number
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">@step.Title</h3>
                        <p class="text-sm text-gray-600 mt-1">@step.Detail</p>
                    </div>
                </div>
            }
        </div>

        @* Endpoints Z-API *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">Endpoints Principais da Z-API</h2>
        <div class="rounded-xl border border-gray-200 bg-gray-900 p-5 font-mono text-sm leading-loose text-gray-100 mb-8">
            <div class="text-gray-500"># Base URL</div>
            <div class="text-blue-300">https://api.z-api.io/instances/{"{INSTANCE_ID}"}/token/{"{TOKEN}"}/</div>
            <br/>
            <div class="text-gray-500"># Enviar texto</div>
            <div><span class="text-green-400">POST</span> <span class="text-blue-300">.../send-text</span></div>
            <div class="text-gray-400">Header: Client-Token: {"{CLIENT_TOKEN}"}</div>
            <div class="text-gray-400">@("{") "phone": "5511999999999", "message": "Ola!" @("}")</div>
            <br/>
            <div class="text-gray-500"># Enviar imagem</div>
            <div><span class="text-green-400">POST</span> <span class="text-blue-300">.../send-image</span></div>
            <div class="text-gray-400">@("{") "phone": "...", "image": "https://...", "caption": "Logo" @("}")</div>
            <br/>
            <div class="text-gray-500"># Marcar como lida</div>
            <div><span class="text-green-400">POST</span> <span class="text-blue-300">.../read-message</span></div>
            <div class="text-gray-400">@("{") "phone": "...", "messageId": "..." @("}")</div>
            <br/>
            <div class="text-gray-500"># Webhook: mensagem recebida (POST no seu servidor)</div>
            <div class="text-amber-400">POST /api/zapi/webhook/receive</div>
            <div class="text-gray-400">@("{") "phone": "...", "text": @("{") "message": "Oi!" @("}"), "senderName": "..." @("}")</div>
            <br/>
            <div class="text-gray-500"># Webhook: status de mensagem</div>
            <div class="text-amber-400">POST /api/zapi/webhook/status</div>
            <div class="text-gray-400">@("{") "status": "READ", "ids": ["..."], "phone": "..." @("}")</div>
        </div>

        @* ===== PARTE 2 — Adaptacao ===== *@
        <div class="rounded-lg bg-[#512bd4]/10 p-4 mb-6 mt-12">
            <h2 class="text-lg font-bold text-[#512bd4]">Parte 2 — Guia para Desenvolvedores CodeCycle</h2>
            <p class="text-sm text-gray-600">Como adaptar este demo Z-API para integrar WhatsApp real no ERP Obraxs.</p>
        </div>

        @* O que muda *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">De Demo para Producao — O Que Muda</h2>
        <div class="rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden mb-8">
            <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-200 bg-gray-50"><th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Aspecto</th><th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Demo (Atual)</th><th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Producao (Z-API)</th></tr></thead>
                <tbody>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Envio de Mensagem</td><td class="px-4 py-2 text-gray-500">Simulador ou Z-API demo</td><td class="px-4 py-2">Z-API com numero dedicado</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Recebimento</td><td class="px-4 py-2 text-gray-500">Webhook Z-API (ja funciona)</td><td class="px-4 py-2">Webhook Z-API + fila de processamento</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Status (ticks)</td><td class="px-4 py-2 text-gray-500">Webhook status (ja funciona)</td><td class="px-4 py-2">Webhook status + retry</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Contatos</td><td class="px-4 py-2 text-gray-500">Seed + auto-criacao</td><td class="px-4 py-2">Sync com base de clientes ERP</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Autenticacao</td><td class="px-4 py-2 text-gray-500">Sem auth</td><td class="px-4 py-2">JWT + roles (admin, atendente)</td></tr>
                    <tr class="border-b border-gray-50"><td class="px-4 py-2 font-medium">Campanhas</td><td class="px-4 py-2 text-gray-500">Envio direto</td><td class="px-4 py-2">Fila com rate limiting + retry</td></tr>
                    <tr><td class="px-4 py-2 font-medium">Multi-tenant</td><td class="px-4 py-2 text-gray-500">Banco unico</td><td class="px-4 py-2">Instancia Z-API por empresa/filial</td></tr>
                </tbody>
            </table>
        </div>

        @* Etapas de Adaptacao *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">Etapas de Adaptacao</h2>
        <div class="space-y-4 mb-8">
            @foreach (var fase in _phases)
            {
                <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
                    <div class="mb-3 flex items-center gap-3">
                        <span class="rounded-full @fase.Color px-2.5 py-1 text-xs font-bold text-white">@fase.Label</span>
                        <h3 class="font-semibold text-gray-900">@fase.Title</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">@fase.Desc</p>
                    <ul class="space-y-1.5">
                        @foreach (var task in fase.Tasks)
                        {
                            <li class="flex items-start gap-2 text-sm text-gray-600">
                                <span class="mt-1.5 h-1.5 w-1.5 flex-shrink-0 rounded-full bg-gray-300"></span>
                                @task
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>

        @* Variaveis de Ambiente *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">Variaveis de Ambiente para Producao</h2>
        <div class="rounded-xl border border-gray-200 bg-gray-900 p-5 font-mono text-sm leading-loose text-gray-100 mb-8">
            <div class="text-gray-500"># Z-API</div>
            <div><span class="text-amber-300">ZAPI_INSTANCE_ID</span>=sua_instancia_producao</div>
            <div><span class="text-amber-300">ZAPI_TOKEN</span>=seu_token_producao</div>
            <div><span class="text-amber-300">ZAPI_CLIENT_TOKEN</span>=seu_client_token</div>
            <br/>
            <div class="text-gray-500"># Banco de dados</div>
            <div><span class="text-amber-300">DATABASE_URL</span>=postgresql://user:pass@@host/db</div>
            <br/>
            <div class="text-gray-500"># Fila + Seguranca</div>
            <div><span class="text-amber-300">REDIS_URL</span>=redis://localhost:6379</div>
            <div><span class="text-amber-300">JWT_SECRET</span>=chave_secreta_forte</div>
        </div>

        @* Links *@
        <h2 class="text-xl font-bold text-gray-900 mb-4">Links Uteis</h2>
        <div class="grid md:grid-cols-2 gap-3 mb-8">
            @foreach (var link in _links)
            {
                <a href="@link.Url" target="_blank"
                   class="flex items-center gap-3 rounded-lg border border-gray-200 bg-white p-3 shadow-sm transition-colors hover:border-whatsapp hover:bg-[#25d366]/5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#25d366" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
                    <span class="text-sm font-medium text-gray-700">@link.Title</span>
                </a>
            }
        </div>

        @* Footer *@
        <div class="text-center text-sm text-gray-400 pb-8 border-t border-gray-200 pt-6">
            <p>Guia de integracao WhatsApp via Z-API para desenvolvedores CodeCycle.</p>
            <p class="mt-1">Este demo e uma referencia arquitetural — adapte os modulos conforme a necessidade do ERP Obraxs.</p>
        </div>
    </div>
</div>

@code {
    private record Step(int Number, string Title, string Detail);
    private record Phase(string Label, string Title, string Desc, string Color, string[] Tasks);
    private record UsefulLink(string Title, string Url);

    private readonly Step[] _steps =
    [
        new(1, "Criar conta na Z-API", "Acesse z-api.io e crie uma conta. O plano inicial permite 1 instancia gratuita para testes."),
        new(2, "Obter credenciais", "No painel, copie o Instance ID, Token e Client-Token da sua instancia."),
        new(3, "Conectar WhatsApp", "Escaneie o QR Code gerado pela Z-API no seu celular (WhatsApp > Dispositivos Conectados)."),
        new(4, "Configurar webhooks", "No painel da Z-API, configure as URLs de webhook apontando para seu servidor (receive, status, disconnected)."),
        new(5, "Configurar env vars", "Defina ZAPI_INSTANCE_ID, ZAPI_TOKEN e ZAPI_CLIENT_TOKEN no ambiente do servidor."),
        new(6, "Testar envio", "Use o Inbox do CRM para enviar uma mensagem. Ela sera enviada pelo WhatsApp real via Z-API.")
    ];

    private readonly Phase[] _phases =
    [
        new("Fase 1", "Ambiente de Producao Z-API", "Configurar instancia Z-API dedicada com numero de producao.", "bg-blue-500",
            ["Criar instancia Z-API dedicada para producao (plano pago)",
             "Numero de telefone dedicado (nao usar pessoal)",
             "Configurar webhooks com HTTPS e validacao",
             "Monitorar status de conexao via /api/zapi/status",
             "Implementar reconexao automatica se desconectar"]),

        new("Fase 2", "Fila de Mensagens", "Adicionar fila para garantir entrega e retry de mensagens.", "bg-green-500",
            ["Implementar fila de mensagens (Redis/RabbitMQ) para outbound",
             "Retry com exponential backoff em caso de falha",
             "Dead letter queue para mensagens que falharam 3x",
             "Rate limiting para nao sobrecarregar o WhatsApp",
             "Dashboard de monitoramento de fila"]),

        new("Fase 3", "Integrar com Base de Clientes do ERP", "Sincronizar contatos do modulo de clientes do Obraxs.", "bg-purple-500",
            ["Sync bidirecional: Cliente ERP → Contato CRM WhatsApp",
             "Auto-criacao de contato ja funciona via webhook",
             "Normalizar telefones (E.164: +5511999999999)",
             "Tags automaticas baseadas em dados do ERP",
             "Opt-in/opt-out com audit trail"]),

        new("Fase 4", "Campanhas com Envio Real", "Adaptar campanhas para envio Z-API com monitoramento.", "bg-amber-500",
            ["CampaignRunner ja envia via Z-API quando configurado",
             "Adicionar delay configuravel entre mensagens",
             "Monitorar status de entrega via webhook",
             "Pausar campanha se muitas falhas consecutivas",
             "Relatorios de performance de campanha"]),

        new("Fase 5", "Autenticacao e Multi-tenant", "Seguranca e suporte a multiplas empresas.", "bg-indigo-500",
            ["Autenticacao via JWT com roles (admin, atendente, visualizador)",
             "Cada empresa/filial com sua instancia Z-API",
             "Isolamento de dados por tenant",
             "Audit log: quem enviou, para quem, quando",
             "Dashboard administrativo cross-tenant"])
    ];

    private readonly UsefulLink[] _links =
    [
        new("Z-API — Site Oficial", "https://z-api.io"),
        new("Z-API — Documentacao", "https://developer.z-api.io"),
        new("Z-API — Enviar Texto", "https://developer.z-api.io/en/message/send-message-text"),
        new("Z-API — Webhooks", "https://developer.z-api.io/en/webhooks/introduction"),
        new("Z-API — Status de Mensagem", "https://developer.z-api.io/en/webhooks/on-whatsapp-message-status-changes"),
        new("Z-API — Enviar Imagem", "https://developer.z-api.io/en/message/send-message-image"),
        new("ASP.NET Core 9 Docs", "https://learn.microsoft.com/en-us/aspnet/core"),
        new("EF Core 9 Docs", "https://learn.microsoft.com/en-us/ef/core")
    ];
}
