@inject HttpClient Http

@if (contacts == null)
{
    <div class="flex items-center justify-center h-32">
        <div class="animate-spin w-6 h-6 border-2 border-whatsapp border-t-transparent rounded-full"></div>
    </div>
}
else
{
    @* Search + Stats *@
    <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center gap-4">
        <div class="relative flex-1 w-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Buscar por nome ou telefone..."
                   class="w-full pl-9 pr-3 py-2 text-sm bg-gray-100 border-0 rounded-lg focus:outline-none focus:ring-2 focus:ring-whatsapp/30" />
        </div>
        <div class="flex gap-4 text-sm text-gray-500">
            <span>Total: <strong class="text-gray-900">@contacts.Count</strong></span>
            <span>Ativos: <strong class="text-green-600">@contacts.Count(c => !c.OptedOut)</strong></span>
            <span>Opt-out: <strong class="text-red-600">@contacts.Count(c => c.OptedOut)</strong></span>
        </div>
    </div>

    @* Tabs *@
    <div class="flex gap-1 mb-4">
        @foreach (var tab in new[] { ("all", "Todos"), ("active", "Ativos"), ("optout", "Opt-out") })
        {
            <button @onclick="() => activeTab = tab.Item1"
                    class="@($"px-3 py-1.5 text-xs font-medium rounded-lg transition-colors {(activeTab == tab.Item1 ? "bg-whatsapp text-white" : "text-gray-500 hover:bg-gray-100")}")">
                @tab.Item2
            </button>
        }
    </div>

    @* Table *@
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200 bg-gray-50">
                        <th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Nome</th>
                        <th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Telefone</th>
                        <th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Tags</th>
                        <th class="text-left text-xs font-medium text-gray-500 px-4 py-3">Origem</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Conversas</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Deals</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Status</th>
                        <th class="text-center text-xs font-medium text-gray-500 px-4 py-3">Acoes</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in FilteredContacts)
                    {
                        <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-whatsapp flex items-center justify-center flex-shrink-0">
                                        <span class="text-white text-xs font-semibold">@GetInitials(c.Name)</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm text-gray-900">@c.Name</div>
                                        @if (!string.IsNullOrEmpty(c.Email))
                                        {
                                            <div class="text-[11px] text-gray-400">@c.Email</div>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">@Formatters.FormatPhone(c.Phone)</td>
                            <td class="px-4 py-3">
                                <div class="flex flex-wrap gap-1">
                                    @foreach (var tag in Formatters.ParseTags(c.Tags).Take(3))
                                    {
                                        <span class="@($"text-[10px] px-1.5 py-0.5 rounded-full font-medium {TagColor(tag)}")">@tag</span>
                                    }
                                    @{
                                        var allTags = Formatters.ParseTags(c.Tags);
                                        if (allTags.Length > 3)
                                        {
                                            <span class="text-[10px] text-gray-400">+@(allTags.Length - 3)</span>
                                        }
                                    }
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                @if (!string.IsNullOrEmpty(c.UtmSource))
                                {
                                    <span class="@($"text-[10px] px-2 py-0.5 rounded-full font-medium {SourceColor(c.UtmSource)}")">@SourceLabel(c.UtmSource)</span>
                                }
                                else
                                {
                                    <span class="text-[10px] text-gray-400">Direto</span>
                                }
                            </td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">@c.ConversationCount</td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">@c.DealCount</td>
                            <td class="px-4 py-3 text-center">
                                <span class="@($"text-[11px] px-2 py-0.5 rounded-full font-medium {(c.OptedOut ? "bg-red-100 text-red-700" : "bg-green-100 text-green-700")}")">
                                    @(c.OptedOut ? "Opt-out" : "Ativo")
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button @onclick="() => ToggleOptOut(c)"
                                        class="@($"text-xs px-3 py-1 rounded-lg transition-colors font-medium {(c.OptedOut ? "text-green-600 hover:bg-green-50 border border-green-200" : "text-red-600 hover:bg-red-50 border border-red-200")}")">
                                    @(c.OptedOut ? "Reativar" : "Opt-out")
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @if (!FilteredContacts.Any())
    {
        <div class="text-center py-8 text-gray-400 text-sm">
            Nenhum contato encontrado
        </div>
    }
}

@code {
    private List<ContactDto>? contacts;
    private string searchTerm = "";
    private string activeTab = "all";

    private IEnumerable<ContactDto> FilteredContacts =>
        (contacts ?? [])
        .Where(c => activeTab == "all" || (activeTab == "active" && !c.OptedOut) || (activeTab == "optout" && c.OptedOut))
        .Where(c => string.IsNullOrEmpty(searchTerm)
            || Formatters.RemoveDiacritics(c.Name.ToLowerInvariant()).Contains(Formatters.RemoveDiacritics(searchTerm.ToLowerInvariant()))
            || c.Phone.Contains(searchTerm));

    protected override async Task OnInitializedAsync() => await LoadContacts();

    private async Task LoadContacts()
    {
        try
        {
            // Parse manually because API returns _count nested object
            var data = await Http.GetFromJsonAsync<JsonElement>("/api/contacts");
            contacts = [];
            foreach (var item in data.EnumerateArray())
            {
                var dto = new ContactDto
                {
                    Id = item.GetProperty("id").GetString()!,
                    Name = item.GetProperty("name").GetString()!,
                    Phone = item.GetProperty("phone").GetString()!,
                    Email = item.TryGetProperty("email", out var email) && email.ValueKind != JsonValueKind.Null
                        ? email.GetString() : null,
                    Tags = item.GetProperty("tags").GetString() ?? "[]",
                    OptedOut = item.GetProperty("optedOut").GetBoolean(),
                    UtmSource = item.TryGetProperty("utmSource", out var utm) && utm.ValueKind != JsonValueKind.Null
                        ? utm.GetString() : null
                };
                if (item.TryGetProperty("conversationCount", out var convs))
                    dto.ConversationCount = convs.GetInt32();
                if (item.TryGetProperty("dealCount", out var deals))
                    dto.DealCount = deals.GetInt32();
                contacts.Add(dto);
            }
        }
        catch { /* ignore */ }
    }

    private async Task ToggleOptOut(ContactDto c)
    {
        try
        {
            await Http.PatchAsJsonAsync("/api/contacts", new { id = c.Id, optedOut = !c.OptedOut });
            await LoadContacts();
        }
        catch { /* ignore */ }
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant();
        return parts.Length > 0 ? parts[0][0].ToString().ToUpperInvariant() : "?";
    }

    private static string SourceLabel(string source) => source.ToLowerInvariant() switch
    {
        "google_ads" => "Google Ads",
        "meta_ads" => "Meta Ads",
        "linkedin_ads" => "LinkedIn",
        "whatsapp" => "WhatsApp",
        "organic" => "Organico",
        "referral" => "Referral",
        "email" => "E-mail",
        _ => source
    };

    private static string SourceColor(string source) => source.ToLowerInvariant() switch
    {
        "google_ads" => "bg-blue-100 text-blue-800",
        "meta_ads" => "bg-purple-100 text-purple-800",
        "linkedin_ads" => "bg-sky-100 text-sky-800",
        "whatsapp" => "bg-green-100 text-green-800",
        "referral" => "bg-amber-100 text-amber-800",
        "organic" => "bg-emerald-100 text-emerald-800",
        _ => "bg-gray-100 text-gray-700"
    };

    private static string TagColor(string tag) => tag.ToLowerInvariant() switch
    {
        "vip" => "bg-amber-100 text-amber-800",
        "lead" => "bg-blue-100 text-blue-800",
        "cliente" => "bg-green-100 text-green-800",
        "inativo" => "bg-gray-100 text-gray-800",
        "prospecto" => "bg-purple-100 text-purple-800",
        "construtora" => "bg-orange-100 text-orange-800",
        "locadora" => "bg-cyan-100 text-cyan-800",
        "prestadora" => "bg-pink-100 text-pink-800",
        "pme" => "bg-indigo-100 text-indigo-800",
        _ => "bg-gray-100 text-gray-700"
    };

    public class ContactDto
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Phone { get; set; } = "";
        public string? Email { get; set; }
        public string Tags { get; set; } = "[]";
        public bool OptedOut { get; set; }
        public string? UtmSource { get; set; }
        public int ConversationCount { get; set; }
        public int DealCount { get; set; }
    }
}
